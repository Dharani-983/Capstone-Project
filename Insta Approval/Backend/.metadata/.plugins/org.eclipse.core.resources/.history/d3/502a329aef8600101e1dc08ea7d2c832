package com.loan_transaction.controller;

import java.util.List;

import org.springframework.context.annotation.Configuration;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

import com.loan_transaction.domain.DocumentType;
import com.loan_transaction.dto.LoanApplicationRequestDTO;
import com.loan_transaction.dto.LoanApplicationResponseDTO;
import com.loan_transaction.service.LoanService;

import lombok.RequiredArgsConstructor;

@RestController
@RequestMapping("/loans")
@RequiredArgsConstructor
@CrossOrigin("*")
public class LoanController {

    private final LoanService loanService;

    // Apply for Loan
    @PostMapping("/apply")
    public ResponseEntity<LoanApplicationResponseDTO> applyForLoan(
            @RequestBody LoanApplicationRequestDTO request,
            @RequestHeader("Authorization") String token) {

        LoanApplicationResponseDTO response = loanService.applyForLoan(request, token);
        return ResponseEntity.ok(response);
    }

    // Get Loan Status
    @GetMapping("/{loanId}/status")
    public ResponseEntity<LoanApplicationResponseDTO> getLoanStatus(@PathVariable Long loanId) {
        LoanApplicationResponseDTO response = loanService.getLoanStatus(loanId);
        return ResponseEntity.ok(response);
    }

    // Update Loan
    @PutMapping("/{loanId}")
    public ResponseEntity<LoanApplicationResponseDTO> updateLoan(
            @PathVariable Long loanId,
            @RequestBody LoanApplicationRequestDTO request,
            @RequestHeader("Authorization") String token) {

        LoanApplicationResponseDTO response = loanService.updateLoan(loanId, request, token);
        return ResponseEntity.ok(response);
    }

    // Cancel Loan
    @DeleteMapping("/{loanId}")
    public ResponseEntity<Void> cancelLoan(
            @PathVariable Long loanId,
            @RequestHeader("Authorization") String token) {

        loanService.cancelLoan(loanId, token);
        return ResponseEntity.noContent().build();
    }

    // Upload Documents
    @PostMapping("/{loanId}/documents")
    public ResponseEntity<List<String>> uploadDocuments(
            @PathVariable Long loanId,
            @RequestParam("files") List<MultipartFile> files,
            @RequestParam("types") List<DocumentType> types,
            @RequestHeader("Authorization") String token) {

        List<String> uploadedFiles = loanService.uploadDocuments(loanId, files, types);
        return ResponseEntity.ok(uploadedFiles);
    }
    @Configuration
    public class WebConfig {

        @Bean
        public WebMvcConfigurer corsConfigurer() {
            return new WebMvcConfigurer() {
                @Override
                public void addCorsMappings(CorsRegistry registry) {
                    registry.addMapping("/**")
                            .allowedOrigins("http://localhost:4200") // frontend URL
                            .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                            .allowedHeaders("*")
                            .allowCredentials(true);
                }
            };
        }
    }
}
